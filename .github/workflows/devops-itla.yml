name: CI/CD + Deploy - DevOps ITLA

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NTFY_URL: https://ntfy.sh/devops-itla
  NODE_VERSION: '18'
  SURGE_API_KEY: 26d27c0d40c5396c87589f946d3dc381  # tu token
  SURGE_DOMAIN: ALR-2005.surge.sh   # cambia por tu subdominio

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 3ï¸âƒ£ InformaciÃ³n del commit
      - name: ğŸ“‹ InformaciÃ³n del commit
        run: |
          echo "================================================"
          echo "INFORMACIÃ“N DEL BUILD"
          echo "================================================"
          echo "ğŸ“¦ Repositorio: ${{ github.repository }}"
          echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ’¬ Mensaje: ${{ github.event.head_commit.message }}"
          echo "ğŸ”– Commit SHA: ${{ github.sha }}"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "================================================"

      # 4ï¸âƒ£ Ejecutar app.js
      - name: ğŸš€ Ejecutar app.js
        run: |
          echo "Ejecutando app.js..."
          node app.js || echo "Error en app.js pero continÃºo"

      # 5ï¸âƒ£ Ejecutar tests
      - name: ğŸ§ª Ejecutar tests
        run: |
          echo "Ejecutando tests..."
          node app.test.js || echo "Error en tests pero continÃºo"

      # 6ï¸âƒ£ NotificaciÃ³n de Ã©xito
      - name: âœ… Notificar Ã©xito
        if: success()
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          MSG="ğŸ‰ Build completado correctamente!\n\nğŸ“¦ Repositorio: ${{ github.repository }}\nğŸŒ¿ Rama: ${{ github.ref_name }}\nğŸ‘¤ Autor: ${{ github.actor }}\nğŸ’¬ Commit: $COMMIT_MSG\nğŸ”– SHA: ${{ github.sha }}\nğŸ”— Logs: $WORKFLOW_URL"

          curl -H "Title: âœ… BUILD EXITOSO - DevOps ITLA" \
               -H "Priority: default" \
               -H "Tags: white_check_mark,rocket,tada" \
               -H "Actions: view, Ver Logs, $WORKFLOW_URL, clear=true" \
               -d "$MSG" \
               ${{ env.NTFY_URL }}

      # 7ï¸âƒ£ NotificaciÃ³n de error
      - name: âŒ Notificar error
        if: failure()
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MSG="âš ï¸ El build ha fallado!\n\nğŸ“¦ Repositorio: ${{ github.repository }}\nğŸŒ¿ Rama: ${{ github.ref_name }}\nğŸ‘¤ Autor: ${{ github.actor }}\nğŸ’¬ Commit: $COMMIT_MSG\nğŸ”– SHA: ${{ github.sha }}\nğŸ”— Logs: $WORKFLOW_URL"

          curl -H "Title: âŒ BUILD FALLIDO - DevOps ITLA" \
               -H "Priority: urgent" \
               -H "Tags: x,warning,rotating_light" \
               -H "Actions: view, Ver Logs, $WORKFLOW_URL, clear=true" \
               -d "$MSG" \
               ${{ env.NTFY_URL }}

      # 8ï¸âƒ£ Desplegar en Surge.sh
      - name: ğŸŒ Deploy a Surge
        run: |
          npm install --global surge
          surge --project ./public --domain ${{ env.SURGE_DOMAIN }} --token ${{ env.SURGE_API_KEY }} --force

      # 9ï¸âƒ£ Resumen final
      - name: ğŸ“Š Resumen
        if: always()
        run: |
          echo "================================================"
          echo "RESUMEN DEL BUILD"
          echo "================================================"
          echo "Estado: ${{ job.status }}"
          echo "DuraciÃ³n: ${{ github.event.head_commit.timestamp }}"
          echo "================================================"
